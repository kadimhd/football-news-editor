<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محرر أخبار كرة القدم — سريع</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.05rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.2rem; height:1.2rem; border: .2rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">📰 محرر أخبار نتائج كرة القدم</h3>
      <span class="text-muted small">v1.1 — أسرع</span>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">

        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label">اليوم</label>
            <select id="daySelect" class="form-select">
              <option value="today">اليوم</option>
              <option value="yesterday">الأمس</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">الدوري (من المباريات المتاحة)</label>
            <select id="leagueSelect" class="form-select">
              <option value="">اختر يوماً ليتم تحميل الدوريات...</option>
            </select>
            <div class="form-text">نعرض فقط الدوريات التي لديها مباريات في اليوم المختار — لتحميل أسرع.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">المباراة</label>
            <select id="matchSelect" class="form-select">
              <option value="">اختر الدوري أولاً</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="refreshBtn" class="btn btn-outline-secondary">تحديث</button>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-6">
            <label class="form-label">مفتاح API (RapidAPI)</label>
            <input id="apiKey" class="form-control mono" type="password" placeholder="ضع مفتاحك هنا" />
            <div class="form-text">لا نخزّن المفتاح؛ يُستخدم محلياً فقط.</div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">لغة الجولة</label>
            <select id="roundLang" class="form-select">
              <option value="arabic" selected>عربي (الجولة 7)</option>
              <option value="raw">كما في الـ API</option>
            </select>
          </div>
        </div>

        <hr/>

        <div class="row g-3">
          <div class="col-12 col-md-3 d-grid">
            <button id="generateBtn" class="btn btn-primary" disabled>✍️ توليد الخبر</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="rephraseBtn" class="btn btn-outline-primary" disabled>🔁 غيّر الصياغة</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="copyBtn" class="btn btn-outline-dark" disabled>📋 نسخ النص</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="clearBtn" class="btn btn-outline-danger">🧹 مسح</button>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label">النص الإخباري</label>
          <textarea id="newsOutput" rows="12" class="form-control" placeholder="هنا سيظهر الخبر الجاهز للتحرير والنسخ..."></textarea>
        </div>

        <div id="statusArea" class="mt-3 text-muted small"></div>
      </div>
    </div>

    <div class="text-center text-muted small mt-3">
      نصيحة: إن تأخّر التحميل، جرّب التبديل بين اليوم/الأمس أو اضغط «تحديث». نحن نستخدم التخزين المؤقت لتسريع التجربة.
    </div>
  </div>

<script>
const API_HOST = "https://api-football-v1.p.rapidapi.com/v3";
const $ = (id) => document.getElementById(id);

function setStatus(html) { $("statusArea").innerHTML = html || ""; }
function fmtNum(n) { return new Intl.NumberFormat('ar-EG').format(n); }
function minuteArabic(min) {
  const m = parseInt(min, 10);
  return isNaN(m) ? `الدقيقة ${min}` : `الدقيقة ${fmtNum(m)}`;
}
function toArabicRound(roundStr, fallback="الجولة") {
  if (!roundStr) return "";
  const m = roundStr.match(/-\s*(\\d+)/);
  if (m) return `${fallback} ${m[1]}`;
  return roundStr;
}
function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// --- Caching layer (sessionStorage) ---
function cacheKey(path) { return "apiCache:" + path; }
function cacheGet(path, maxAgeMs=120000) { // default 2 min
  try {
    const raw = sessionStorage.getItem(cacheKey(path));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.t > maxAgeMs) return null;
    return obj.v;
  } catch { return null; }
}
function cacheSet(path, value) {
  try { sessionStorage.setItem(cacheKey(path), JSON.stringify({ t: Date.now(), v: value })); } catch {}
}

// --- Fetch with timeout & graceful errors ---
async function apiGet(path, { timeoutMs=12000 } = {}) {
  const key = $("apiKey").value.trim();
  if (!key) throw new Error("يرجى إدخال مفتاح API أولاً.");
  const cached = cacheGet(path);
  if (cached) return cached;

  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const res = await fetch(API_HOST + path, {
      headers: {
        "x-rapidapi-key": key,
        "x-rapidapi-host": "api-football-v1.p.rapidapi.com"
      },
      signal: controller.signal
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`خطأ ${res.status}: ${text}`);
    }
    const data = await res.json();
    cacheSet(path, data);
    return data;
  } catch (e) {
    if (e.name === "AbortError") throw new Error("المهلة انتهت. تحقق من الشبكة أو أعد المحاولة.");
    throw e;
  } finally {
    clearTimeout(timer);
  }
}

// --- Load leagues by scanning fixtures of the chosen day (faster + relevant) ---
async function loadLeaguesFromFixtures() {
  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);
  const path = `/fixtures?date=${ymd}`;

  const leagueSel = $("leagueSelect");
  leagueSel.innerHTML = `<option value="">جاري تحميل الدوريات <span class="spinner"></span></option>`;
  setStatus(`جلب المباريات لليوم ${ymd} <span class="spinner"></span>`);

  try {
    const data = await apiGet(path);
    const fixtures = data.response || [];
    if (!fixtures.length) {
      leagueSel.innerHTML = `<option value="">لا توجد مباريات في هذا اليوم</option>`;
      $("matchSelect").innerHTML = `<option value="">—</option>`;
      $("generateBtn").disabled = true;
      setStatus("لا توجد مباريات.");
      return;
    }
    // Build league list from fixtures
    const map = new Map();
    for (const f of fixtures) {
      const lid = f.league?.id;
      if (!lid) continue;
      if (!map.has(lid)) {
        map.set(lid, { id: lid, name: f.league?.name || `League ${lid}`, season: f.league?.season, country: f.league?.country || "" });
      }
    }
    // Sort by country then name
    const leagues = Array.from(map.values()).sort((a,b) => (`${a.country}-${a.name}`).localeCompare(`${b.country}-${b.name}`, 'ar'));
    leagueSel.innerHTML = "";
    for (const L of leagues) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify(L);
      opt.textContent = `${L.name}${L.country ? " ("+L.country+")" : ""}`;
      leagueSel.appendChild(opt);
    }
    setStatus(`تم تحميل ${leagues.length} دوري من مباريات اليوم.`);
    await loadMatchesForSelectedLeague(fixtures); // Reuse fixtures to avoid extra call
  } catch (e) {
    leagueSel.innerHTML = `<option value="">تعذر تحميل الدوريات (${e.message})</option>`;
    setStatus(`<span class="text-danger">خطأ: ${e.message}</span>`);
  }
}

async function loadMatchesForSelectedLeague(prefetchedFixtures=null) {
  const val = $("leagueSelect").value;
  const matchSel = $("matchSelect");
  matchSel.innerHTML = `<option value="">جاري تحميل المباريات <span class="spinner"></span></option>`;
  $("generateBtn").disabled = true;

  if (!val) { matchSel.innerHTML = `<option value="">—</option>`; return; }

  const { id: leagueId } = JSON.parse(val);

  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);

  try {
    let fixtures;
    if (prefetchedFixtures) {
      fixtures = prefetchedFixtures.filter(f => f.league?.id === leagueId);
    } else {
      const data = await apiGet(`/fixtures?league=${leagueId}&date=${ymd}`);
      fixtures = data.response || [];
    }
    if (!fixtures.length) {
      matchSel.innerHTML = `<option value="">لا مباريات لهذا الدوري في هذا اليوم</option>`;
      setStatus("لا مباريات متاحة لهذا الدوري.");
      return;
    }
    matchSel.innerHTML = "";
    for (const f of fixtures) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ fixtureId: f.fixture.id, leagueId, season: f.league?.season, homeId: f.teams?.home?.id, awayId: f.teams?.away?.id });
      opt.textContent = `${f.teams.home.name} ضد ${f.teams.away.name} — ${f.goals.home ?? ""}:${f.goals.away ?? ""}`;
      matchSel.appendChild(opt);
    }
    $("generateBtn").disabled = false;
    setStatus(`تم تحميل ${fixtures.length} مباراة.`);
  } catch (e) {
    matchSel.innerHTML = `<option value="">تعذر تحميل المباريات (${e.message})</option>`;
    setStatus(`<span class="text-danger">خطأ: ${e.message}</span>`);
  }
}

// --- Report generation ---
let lastReportData = null;
let templatesIndex = 0;

function buildReportText(payload) {
  const {
    leagueName, roundStr, roundLang, homeName, awayName,
    homeGoals, awayGoals, goalEvents, redCards, homePos, awayPos
  } = payload;

  const arabicRound = (roundLang === "arabic") ? toArabicRound(roundStr) : roundStr;

  const scorerLines = goalEvents.length
    ? "أهداف المباراة جاءت عبر: " + goalEvents.map(g => `${g.player} (${g.team}) في ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redLines = redCards.length
    ? "وشهد اللقاء حالات طرد: " + redCards.map(r => `${r.player} (${r.team}) في ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcomeVerb = (() => {
    if (homeGoals > awayGoals) return "انتصر";
    if (homeGoals < awayGoals) return "خسر";
    return "تعادل";
  })();

  const leadVariants = [
    () => `${homeName} ${outcomeVerb === "انتصر" ? "حصد" : outcomeVerb === "خسر" ? "فشل في نيل" : "اقتسم"} النقاط أمام ${awayName} ضمن منافسات ${leagueName}${arabicRound ? " في " + arabicRound : ""}، حيث انتهت المواجهة بنتيجة ${homeGoals}–${awayGoals}.`,
    () => `ضمن ${leagueName}${arabicRound ? " (" + arabicRound + ")" : ""}، فرضت نتيجة ${homeGoals}–${awayGoals} كلمتها في مواجهة ${homeName} مع ${awayName}.`,
    () => `حملت مواجهة ${homeName} و${awayName} في ${leagueName}${arabicRound ? " — " + arabicRound : ""} إثارة كبيرة، وانتهت على وقع ${homeGoals}–${awayGoals}.`
  ];

  const midVariants = [
    () => scorerLines,
    () => (scorerLines ? scorerLines : "لم تُسجّل تفاصيل الأهداف في السجلات المتاحة."),
    () => [scorerLines, redLines].filter(Boolean).join(" ")
  ];

  const tailVariants = [
    () => `وفي جدول الترتيب، يتموضع ${homeName} في المركز ${fmtNum(homePos)} بينما يحتل ${awayName} المرتبة ${fmtNum(awayPos)}.`,
    () => `ترتيبيًا: ${homeName} (${fmtNum(homePos)}) و${awayName} (${fmtNum(awayPos)}).`,
    () => `على صعيد الجدول، ${homeName} ${homePos} مقابل ${awayPos} لـ${awayName}.`
  ];

  const parts = [
    leadVariants[templatesIndex % leadVariants.length](),
    midVariants[templatesIndex % midVariants.length](),
    (redLines && templatesIndex % 2 === 1) ? "" : redLines,
    tailVariants[templatesIndex % tailVariants.length]()
  ].filter(Boolean);

  return parts.join("\n");
}

async function generateNews() {
  const val = $("matchSelect").value;
  if (!val) { alert("اختر مباراة."); return; }
  const { fixtureId, leagueId, season, homeId, awayId } = JSON.parse(val);
  setStatus(`جلب تفاصيل المباراة ${fixtureId} <span class="spinner"></span>`);

  try {
    const fxData = await apiGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if (!fx) throw new Error("لا توجد بيانات للمباراة.");

    const leagueName = fx.league?.name || "الدوري";
    const roundStr = fx.league?.round || "";
    const homeName = fx.teams?.home?.name || "الفريق المضيف";
    const awayName = fx.teams?.away?.name || "الفريق الضيف";
    const homeGoals = fx.goals?.home ?? 0;
    const awayGoals = fx.goals?.away ?? 0;

    const evData = await apiGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];

    const goals = ev.filter(e => e.type === "Goal").map(e => ({
      player: e.player?.name || "غير معلوم",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    const reds = ev.filter(e => e.detail === "Red Card").map(e => ({
      player: e.player?.name || "غير معلوم",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    // standings
    const stData = await apiGet(`/standings?league=${leagueId}&season=${season}`);
    const allStandings = stData.response?.[0]?.league?.standings || [];
    const table = [].concat(...allStandings);
    const homeRow = table.find(r => r.team?.id === (homeId || fx.teams?.home?.id));
    const awayRow = table.find(r => r.team?.id === (awayId || fx.teams?.away?.id));
    const homePos = homeRow?.rank ?? "—";
    const awayPos = awayRow?.rank ?? "—";

    const payload = {
      leagueName, roundStr, roundLang: $("roundLang").value,
      homeName, awayName, homeGoals, awayGoals,
      goalEvents: goals, redCards: reds, homePos, awayPos
    };
    templatesIndex = 0;
    $("newsOutput").value = buildReportText(payload);
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
    setStatus("تم توليد الخبر.");
  } catch (e) {
    setStatus(`<span class="text-danger">فشل توليد الخبر: ${e.message}</span>`);
  }
}

// --- UI ---
$("daySelect").addEventListener("change", loadLeaguesFromFixtures);
$("leagueSelect").addEventListener("change", () => loadMatchesForSelectedLeague());
$("refreshBtn").addEventListener("click", loadLeaguesFromFixtures);
$("generateBtn").addEventListener("click", generateNews);
$("rephraseBtn").addEventListener("click", () => {
  const current = $("newsOutput").value.trim();
  if (!current) return;
  templatesIndex++;
  $("newsOutput").value = buildReportText({
    ...extractCurrentPayload(),
  });
});
$("copyBtn").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText($("newsOutput").value);
    $("copyBtn").textContent = "✅ تم النسخ";
    setTimeout(() => $("copyBtn").textContent = "📋 نسخ النص", 1200);
  } catch {
    alert("لم يتم النسخ تلقائياً. انسخ يدوياً.");
  }
});
$("clearBtn").addEventListener("click", () => {
  $("newsOutput").value = "";
  $("rephraseBtn").disabled = true;
  $("copyBtn").disabled = true;
  setStatus("");
});

function extractCurrentPayload() {
  return lastGeneratedPayload || {};
}

let lastGeneratedPayload = null;
const originalBuildReportText = buildReportText;
buildReportText = function(payload) {
  lastGeneratedPayload = payload;
  return originalBuildReportText(payload);
};

// initial
setStatus("أدخل مفتاح API ثم اختر اليوم واضغط «تحديث»."); 
</script>
</body>
</html>
