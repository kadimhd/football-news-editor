<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… â€” Ø³Ø±ÙŠØ¹</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.05rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .spinner { display:inline-block; width:1.2rem; height:1.2rem; border: .2rem solid #ddd; border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-3 p-md-4">

  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">ğŸ“° Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± Ù†ØªØ§Ø¦Ø¬ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…</h3>
      <span class="text-muted small">v1.1 â€” Ø£Ø³Ø±Ø¹</span>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">

        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
            <select id="daySelect" class="form-select">
              <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
              <option value="yesterday">Ø§Ù„Ø£Ù…Ø³</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©)</label>
            <select id="leagueSelect" class="form-select">
              <option value="">Ø§Ø®ØªØ± ÙŠÙˆÙ…Ø§Ù‹ Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª...</option>
            </select>
            <div class="form-text">Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙ‡Ø§ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± â€” Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø±Ø¹.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</label>
            <select id="matchSelect" class="form-select">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø£ÙˆÙ„Ø§Ù‹</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="refreshBtn" class="btn btn-outline-secondary">ØªØ­Ø¯ÙŠØ«</button>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-6">
            <label class="form-label">Ù…ÙØªØ§Ø­ API (RapidAPI)</label>
            <input id="apiKey" class="form-control mono" type="password" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§" />
            <div class="form-text">Ù„Ø§ Ù†Ø®Ø²Ù‘Ù† Ø§Ù„Ù…ÙØªØ§Ø­Ø› ÙŠÙØ³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·.</div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Ù„ØºØ© Ø§Ù„Ø¬ÙˆÙ„Ø©</label>
            <select id="roundLang" class="form-select">
              <option value="arabic" selected>Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø¬ÙˆÙ„Ø© 7)</option>
              <option value="raw">ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù€ API</option>
            </select>
          </div>
        </div>

        <hr/>

        <div class="row g-3">
          <div class="col-12 col-md-3 d-grid">
            <button id="generateBtn" class="btn btn-primary" disabled>âœï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="rephraseBtn" class="btn btn-outline-primary" disabled>ğŸ” ØºÙŠÙ‘Ø± Ø§Ù„ØµÙŠØ§ØºØ©</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="copyBtn" class="btn btn-outline-dark" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="clearBtn" class="btn btn-outline-danger">ğŸ§¹ Ù…Ø³Ø­</button>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ</label>
          <textarea id="newsOutput" rows="12" class="form-control" placeholder="Ù‡Ù†Ø§ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø®..."></textarea>
        </div>

        <div id="statusArea" class="mt-3 text-muted small"></div>
      </div>
    </div>

    <div class="text-center text-muted small mt-3">
      Ù†ØµÙŠØ­Ø©: Ø¥Ù† ØªØ£Ø®Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ù…Ø³ Ø£Ùˆ Ø§Ø¶ØºØ· Â«ØªØ­Ø¯ÙŠØ«Â». Ù†Ø­Ù† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø©.
    </div>
  </div>

<script>
const API_HOST = "https://api-football-v1.p.rapidapi.com/v3";
const $ = (id) => document.getElementById(id);

function setStatus(html) { $("statusArea").innerHTML = html || ""; }
function fmtNum(n) { return new Intl.NumberFormat('ar-EG').format(n); }
function minuteArabic(min) {
  const m = parseInt(min, 10);
  return isNaN(m) ? `Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${min}` : `Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${fmtNum(m)}`;
}
function toArabicRound(roundStr, fallback="Ø§Ù„Ø¬ÙˆÙ„Ø©") {
  if (!roundStr) return "";
  const m = roundStr.match(/-\s*(\\d+)/);
  if (m) return `${fallback} ${m[1]}`;
  return roundStr;
}
function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

// --- Caching layer (sessionStorage) ---
function cacheKey(path) { return "apiCache:" + path; }
function cacheGet(path, maxAgeMs=120000) { // default 2 min
  try {
    const raw = sessionStorage.getItem(cacheKey(path));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.t > maxAgeMs) return null;
    return obj.v;
  } catch { return null; }
}
function cacheSet(path, value) {
  try { sessionStorage.setItem(cacheKey(path), JSON.stringify({ t: Date.now(), v: value })); } catch {}
}

// --- Fetch with timeout & graceful errors ---
async function apiGet(path, { timeoutMs=12000 } = {}) {
  const key = $("apiKey").value.trim();
  if (!key) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹.");
  const cached = cacheGet(path);
  if (cached) return cached;

  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const res = await fetch(API_HOST + path, {
      headers: {
        "x-rapidapi-key": key,
        "x-rapidapi-host": "api-football-v1.p.rapidapi.com"
      },
      signal: controller.signal
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Ø®Ø·Ø£ ${res.status}: ${text}`);
    }
    const data = await res.json();
    cacheSet(path, data);
    return data;
  } catch (e) {
    if (e.name === "AbortError") throw new Error("Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù†ØªÙ‡Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
    throw e;
  } finally {
    clearTimeout(timer);
  }
}

// --- Load leagues by scanning fixtures of the chosen day (faster + relevant) ---
async function loadLeaguesFromFixtures() {
  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);
  const path = `/fixtures?date=${ymd}`;

  const leagueSel = $("leagueSelect");
  leagueSel.innerHTML = `<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª <span class="spinner"></span></option>`;
  setStatus(`Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„Ù„ÙŠÙˆÙ… ${ymd} <span class="spinner"></span>`);

  try {
    const data = await apiGet(path);
    const fixtures = data.response || [];
    if (!fixtures.length) {
      leagueSel.innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</option>`;
      $("matchSelect").innerHTML = `<option value="">â€”</option>`;
      $("generateBtn").disabled = true;
      setStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª.");
      return;
    }
    // Build league list from fixtures
    const map = new Map();
    for (const f of fixtures) {
      const lid = f.league?.id;
      if (!lid) continue;
      if (!map.has(lid)) {
        map.set(lid, { id: lid, name: f.league?.name || `League ${lid}`, season: f.league?.season, country: f.league?.country || "" });
      }
    }
    // Sort by country then name
    const leagues = Array.from(map.values()).sort((a,b) => (`${a.country}-${a.name}`).localeCompare(`${b.country}-${b.name}`, 'ar'));
    leagueSel.innerHTML = "";
    for (const L of leagues) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify(L);
      opt.textContent = `${L.name}${L.country ? " ("+L.country+")" : ""}`;
      leagueSel.appendChild(opt);
    }
    setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${leagues.length} Ø¯ÙˆØ±ÙŠ Ù…Ù† Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ….`);
    await loadMatchesForSelectedLeague(fixtures); // Reuse fixtures to avoid extra call
  } catch (e) {
    leagueSel.innerHTML = `<option value="">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (${e.message})</option>`;
    setStatus(`<span class="text-danger">Ø®Ø·Ø£: ${e.message}</span>`);
  }
}

async function loadMatchesForSelectedLeague(prefetchedFixtures=null) {
  const val = $("leagueSelect").value;
  const matchSel = $("matchSelect");
  matchSel.innerHTML = `<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª <span class="spinner"></span></option>`;
  $("generateBtn").disabled = true;

  if (!val) { matchSel.innerHTML = `<option value="">â€”</option>`; return; }

  const { id: leagueId } = JSON.parse(val);

  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);

  try {
    let fixtures;
    if (prefetchedFixtures) {
      fixtures = prefetchedFixtures.filter(f => f.league?.id === leagueId);
    } else {
      const data = await apiGet(`/fixtures?league=${leagueId}&date=${ymd}`);
      fixtures = data.response || [];
    }
    if (!fixtures.length) {
      matchSel.innerHTML = `<option value="">Ù„Ø§ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</option>`;
      setStatus("Ù„Ø§ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ±ÙŠ.");
      return;
    }
    matchSel.innerHTML = "";
    for (const f of fixtures) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ fixtureId: f.fixture.id, leagueId, season: f.league?.season, homeId: f.teams?.home?.id, awayId: f.teams?.away?.id });
      opt.textContent = `${f.teams.home.name} Ø¶Ø¯ ${f.teams.away.name} â€” ${f.goals.home ?? ""}:${f.goals.away ?? ""}`;
      matchSel.appendChild(opt);
    }
    $("generateBtn").disabled = false;
    setStatus(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${fixtures.length} Ù…Ø¨Ø§Ø±Ø§Ø©.`);
  } catch (e) {
    matchSel.innerHTML = `<option value="">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (${e.message})</option>`;
    setStatus(`<span class="text-danger">Ø®Ø·Ø£: ${e.message}</span>`);
  }
}

// --- Report generation ---
let lastReportData = null;
let templatesIndex = 0;

function buildReportText(payload) {
  const {
    leagueName, roundStr, roundLang, homeName, awayName,
    homeGoals, awayGoals, goalEvents, redCards, homePos, awayPos
  } = payload;

  const arabicRound = (roundLang === "arabic") ? toArabicRound(roundStr) : roundStr;

  const scorerLines = goalEvents.length
    ? "Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø§Ø¡Øª Ø¹Ø¨Ø±: " + goalEvents.map(g => `${g.player} (${g.team}) ÙÙŠ ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redLines = redCards.length
    ? "ÙˆØ´Ù‡Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡ Ø­Ø§Ù„Ø§Øª Ø·Ø±Ø¯: " + redCards.map(r => `${r.player} (${r.team}) ÙÙŠ ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcomeVerb = (() => {
    if (homeGoals > awayGoals) return "Ø§Ù†ØªØµØ±";
    if (homeGoals < awayGoals) return "Ø®Ø³Ø±";
    return "ØªØ¹Ø§Ø¯Ù„";
  })();

  const leadVariants = [
    () => `${homeName} ${outcomeVerb === "Ø§Ù†ØªØµØ±" ? "Ø­ØµØ¯" : outcomeVerb === "Ø®Ø³Ø±" ? "ÙØ´Ù„ ÙÙŠ Ù†ÙŠÙ„" : "Ø§Ù‚ØªØ³Ù…"} Ø§Ù„Ù†Ù‚Ø§Ø· Ø£Ù…Ø§Ù… ${awayName} Ø¶Ù…Ù† Ù…Ù†Ø§ÙØ³Ø§Øª ${leagueName}${arabicRound ? " ÙÙŠ " + arabicRound : ""}ØŒ Ø­ÙŠØ« Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†ØªÙŠØ¬Ø© ${homeGoals}â€“${awayGoals}.`,
    () => `Ø¶Ù…Ù† ${leagueName}${arabicRound ? " (" + arabicRound + ")" : ""}ØŒ ÙØ±Ø¶Øª Ù†ØªÙŠØ¬Ø© ${homeGoals}â€“${awayGoals} ÙƒÙ„Ù…ØªÙ‡Ø§ ÙÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø© ${homeName} Ù…Ø¹ ${awayName}.`,
    () => `Ø­Ù…Ù„Øª Ù…ÙˆØ§Ø¬Ù‡Ø© ${homeName} Ùˆ${awayName} ÙÙŠ ${leagueName}${arabicRound ? " â€” " + arabicRound : ""} Ø¥Ø«Ø§Ø±Ø© ÙƒØ¨ÙŠØ±Ø©ØŒ ÙˆØ§Ù†ØªÙ‡Øª Ø¹Ù„Ù‰ ÙˆÙ‚Ø¹ ${homeGoals}â€“${awayGoals}.`
  ];

  const midVariants = [
    () => scorerLines,
    () => (scorerLines ? scorerLines : "Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©."),
    () => [scorerLines, redLines].filter(Boolean).join(" ")
  ];

  const tailVariants = [
    () => `ÙˆÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ ÙŠØªÙ…ÙˆØ¶Ø¹ ${homeName} ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${fmtNum(homePos)} Ø¨ÙŠÙ†Ù…Ø§ ÙŠØ­ØªÙ„ ${awayName} Ø§Ù„Ù…Ø±ØªØ¨Ø© ${fmtNum(awayPos)}.`,
    () => `ØªØ±ØªÙŠØ¨ÙŠÙ‹Ø§: ${homeName} (${fmtNum(homePos)}) Ùˆ${awayName} (${fmtNum(awayPos)}).`,
    () => `Ø¹Ù„Ù‰ ØµØ¹ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ ${homeName} ${homePos} Ù…Ù‚Ø§Ø¨Ù„ ${awayPos} Ù„Ù€${awayName}.`
  ];

  const parts = [
    leadVariants[templatesIndex % leadVariants.length](),
    midVariants[templatesIndex % midVariants.length](),
    (redLines && templatesIndex % 2 === 1) ? "" : redLines,
    tailVariants[templatesIndex % tailVariants.length]()
  ].filter(Boolean);

  return parts.join("\n");
}

async function generateNews() {
  const val = $("matchSelect").value;
  if (!val) { alert("Ø§Ø®ØªØ± Ù…Ø¨Ø§Ø±Ø§Ø©."); return; }
  const { fixtureId, leagueId, season, homeId, awayId } = JSON.parse(val);
  setStatus(`Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ${fixtureId} <span class="spinner"></span>`);

  try {
    const fxData = await apiGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if (!fx) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©.");

    const leagueName = fx.league?.name || "Ø§Ù„Ø¯ÙˆØ±ÙŠ";
    const roundStr = fx.league?.round || "";
    const homeName = fx.teams?.home?.name || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¶ÙŠÙ";
    const awayName = fx.teams?.away?.name || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¶ÙŠÙ";
    const homeGoals = fx.goals?.home ?? 0;
    const awayGoals = fx.goals?.away ?? 0;

    const evData = await apiGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];

    const goals = ev.filter(e => e.type === "Goal").map(e => ({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    const reds = ev.filter(e => e.detail === "Red Card").map(e => ({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    // standings
    const stData = await apiGet(`/standings?league=${leagueId}&season=${season}`);
    const allStandings = stData.response?.[0]?.league?.standings || [];
    const table = [].concat(...allStandings);
    const homeRow = table.find(r => r.team?.id === (homeId || fx.teams?.home?.id));
    const awayRow = table.find(r => r.team?.id === (awayId || fx.teams?.away?.id));
    const homePos = homeRow?.rank ?? "â€”";
    const awayPos = awayRow?.rank ?? "â€”";

    const payload = {
      leagueName, roundStr, roundLang: $("roundLang").value,
      homeName, awayName, homeGoals, awayGoals,
      goalEvents: goals, redCards: reds, homePos, awayPos
    };
    templatesIndex = 0;
    $("newsOutput").value = buildReportText(payload);
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
    setStatus("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±.");
  } catch (e) {
    setStatus(`<span class="text-danger">ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±: ${e.message}</span>`);
  }
}

// --- UI ---
$("daySelect").addEventListener("change", loadLeaguesFromFixtures);
$("leagueSelect").addEventListener("change", () => loadMatchesForSelectedLeague());
$("refreshBtn").addEventListener("click", loadLeaguesFromFixtures);
$("generateBtn").addEventListener("click", generateNews);
$("rephraseBtn").addEventListener("click", () => {
  const current = $("newsOutput").value.trim();
  if (!current) return;
  templatesIndex++;
  $("newsOutput").value = buildReportText({
    ...extractCurrentPayload(),
  });
});
$("copyBtn").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText($("newsOutput").value);
    $("copyBtn").textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®";
    setTimeout(() => $("copyBtn").textContent = "ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ", 1200);
  } catch {
    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.");
  }
});
$("clearBtn").addEventListener("click", () => {
  $("newsOutput").value = "";
  $("rephraseBtn").disabled = true;
  $("copyBtn").disabled = true;
  setStatus("");
});

function extractCurrentPayload() {
  return lastGeneratedPayload || {};
}

let lastGeneratedPayload = null;
const originalBuildReportText = buildReportText;
buildReportText = function(payload) {
  lastGeneratedPayload = payload;
  return originalBuildReportText(payload);
};

// initial
setStatus("Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ API Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ø¶ØºØ· Â«ØªØ­Ø¯ÙŠØ«Â»."); 
</script>
</body>
</html>
