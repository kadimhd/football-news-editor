<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.05rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="p-3 p-md-4">

  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">ğŸ“° Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø± Ù†ØªØ§Ø¦Ø¬ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…</h3>
      <span class="text-muted small">v1.0</span>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
            <select id="daySelect" class="form-select">
              <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
              <option value="yesterday">Ø§Ù„Ø£Ù…Ø³</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ø¯ÙˆØ±ÙŠ</label>
            <select id="leagueSelect" class="form-select"></select>
            <div class="form-text">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø§Ù„Ø¢Ù†.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©</label>
            <select id="matchSelect" class="form-select">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø£ÙˆÙ„Ø§Ù‹</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="refreshBtn" class="btn btn-outline-secondary">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
          </div>
        </div>

        <hr/>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Ù…ÙØªØ§Ø­ API (RapidAPI)</label>
            <input id="apiKey" class="form-control mono" type="password" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§" />
            <div class="form-text">Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ØŒ ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø· Ø¶Ù…Ù† Ø§Ù„ØµÙØ­Ø©.</div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Ù„ØºØ© Ø§Ù„Ø¬ÙˆÙ„Ø©</label>
            <select id="roundLang" class="form-select">
              <option value="arabic" selected>Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø¬ÙˆÙ„Ø© 7)</option>
              <option value="raw">ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù€ API</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-3 d-grid">
            <button id="generateBtn" class="btn btn-primary">âœï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="rephraseBtn" class="btn btn-outline-primary" disabled>ğŸ” ØºÙŠÙ‘Ø± Ø§Ù„ØµÙŠØ§ØºØ©</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="copyBtn" class="btn btn-outline-dark" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="clearBtn" class="btn btn-outline-danger">ğŸ§¹ Ù…Ø³Ø­</button>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label">Ø§Ù„Ù†Øµ Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ</label>
          <textarea id="newsOutput" rows="12" class="form-control" placeholder="Ù‡Ù†Ø§ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø®..."></textarea>
        </div>
      </div>
    </div>

    <div class="text-center text-muted small mt-3">
      ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù„Ø£ØºØ±Ø§Ø¶ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¨Ø³Ø±Ø¹Ø© â€” Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù…Ù† RapidAPIØŒ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· &laquo;ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±&raquo;.
    </div>
  </div>

<script>
const API_HOST = "https://api-football-v1.p.rapidapi.com/v3";

// ---------- Helpers ----------
const $ = (id) => document.getElementById(id);
const fmtNum = (n) => new Intl.NumberFormat('ar-EG').format(n);

function toArabicRound(roundStr, fallback="Ø§Ù„Ø¬ÙˆÙ„Ø©") {
  // Examples: "Regular Season - 7", "Group A - 3"
  if (!roundStr) return "";
  const m = roundStr.match(/-\s*(\d+)/);
  if (m) return `${fallback} ${m[1]}`;
  return roundStr;
}

function minuteArabic(min) {
  try {
    const m = parseInt(min, 10);
    if (!isNaN(m)) return `Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${fmtNum(m)}`;
  } catch {}
  return `Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ${min}`;
}

function unique(arr) { return Array.from(new Set(arr)); }

function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function normalizeTeamName(name) {
  // Simple normalizer if needed later
  return name;
}

// ---------- API Calls ----------
async function apiGet(path) {
  const key = $("apiKey").value.trim();
  if (!key) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹.");
  const headers = {
    "x-rapidapi-key": key,
    "x-rapidapi-host": "api-football-v1.p.rapidapi.com"
  };
  const res = await fetch(`${API_HOST}${path}`, { headers });
  if (!res.ok) {
    const text = await res.text();
    throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨: " + res.status + " â€” " + text);
  }
  const data = await res.json();
  return data;
}

async function loadLeagues() {
  const leaguesSel = $("leagueSelect");
  leaguesSel.innerHTML = `<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>`;
  try {
    const data = await apiGet(`/leagues?current=true`);
    // Sort by type & country & name for better UX
    const leagues = data.response.sort((a, b) => {
      const ta = `${a.league.type}-${a.country?.name}-${a.league.name}`;
      const tb = `${b.league.type}-${b.country?.name}-${b.league.name}`;
      return ta.localeCompare(tb, 'ar');
    });
    leaguesSel.innerHTML = "";
    for (const l of leagues) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ id: l.league.id, season: l.seasons?.find(s => s.current)?.year || l.seasons?.[0]?.year });
      opt.textContent = `${l.league.name} (${l.country?.name || "N/A"})`;
      leaguesSel.appendChild(opt);
    }
  } catch (e) {
    leaguesSel.innerHTML = `<option value="">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª (${e.message})</option>`;
  }
}

async function loadMatches() {
  const selVal = $("leagueSelect").value;
  const matchesSel = $("matchSelect");
  matchesSel.innerHTML = `<option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª...</option>`;
  if (!selVal) return;
  const { id: leagueId, season } = JSON.parse(selVal);

  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);

  try {
    const data = await apiGet(`/fixtures?league=${leagueId}&season=${season}&date=${ymd}`);
    const fixtures = data.response || [];
    if (!fixtures.length) {
      matchesSel.innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</option>`;
      return;
    }
    matchesSel.innerHTML = "";
    for (const f of fixtures) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ fixtureId: f.fixture.id, leagueId, season });
      opt.textContent = `${f.teams.home.name} Ø¶Ø¯ ${f.teams.away.name} â€” ${f.goals.home ?? ""}:${f.goals.away ?? ""}`;
      matchesSel.appendChild(opt);
    }
  } catch (e) {
    matchesSel.innerHTML = `<option value="">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª (${e.message})</option>`;
  }
}

// ---------- News Generation ----------
let lastReportData = null;
let templatesIndex = 0;

function buildReportText(payload) {
  const {
    leagueName, roundStr, roundLang, homeName, awayName,
    homeGoals, awayGoals, goalEvents, redCards, homePos, awayPos
  } = payload;

  const arabicRound = (roundLang === "arabic") ? toArabicRound(roundStr) : roundStr;

  const scorerLines = goalEvents.length
    ? "Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø§Ø¡Øª Ø¹Ø¨Ø±: " + goalEvents.map(g => `${g.player} (${g.team}) ÙÙŠ ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redLines = redCards.length
    ? "ÙˆØ´Ù‡Ø¯ Ø§Ù„Ù„Ù‚Ø§Ø¡ Ø­Ø§Ù„Ø§Øª Ø·Ø±Ø¯: " + redCards.map(r => `${r.player} (${r.team}) ÙÙŠ ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcomeVerb = (() => {
    if (homeGoals > awayGoals) return "Ø§Ù†ØªØµØ±";
    if (homeGoals < awayGoals) return "Ø®Ø³Ø±";
    return "ØªØ¹Ø§Ø¯Ù„";
  })();

  const leadVariants = [
    () => `${normalizeTeamName(homeName)} ${outcomeVerb === "Ø§Ù†ØªØµØ±" ? "Ø­ØµØ¯" : outcomeVerb === "Ø®Ø³Ø±" ? "ÙØ´Ù„ ÙÙŠ Ù†ÙŠÙ„" : "Ø§Ù‚ØªØ³Ù…"} Ø§Ù„Ù†Ù‚Ø§Ø· Ø£Ù…Ø§Ù… ${normalizeTeamName(awayName)} Ø¶Ù…Ù† Ù…Ù†Ø§ÙØ³Ø§Øª ${leagueName}${arabicRound ? " ÙÙŠ " + arabicRound : ""}ØŒ Ø­ÙŠØ« Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†ØªÙŠØ¬Ø© ${homeGoals}â€“${awayGoals}.`,
    () => `Ø¶Ù…Ù† ${leagueName}${arabicRound ? " (" + arabicRound + ")" : ""}ØŒ ÙØ±Ø¶Øª Ù†ØªÙŠØ¬Ø© ${homeGoals}â€“${awayGoals} ÙƒÙ„Ù…ØªÙ‡Ø§ ÙÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø© ${normalizeTeamName(homeName)} Ù…Ø¹ ${normalizeTeamName(awayName)}.`,
    () => `Ø­Ù…Ù„Øª Ù…ÙˆØ§Ø¬Ù‡Ø© ${normalizeTeamName(homeName)} Ùˆ${normalizeTeamName(awayName)} ÙÙŠ ${leagueName}${arabicRound ? " â€” " + arabicRound : ""} Ø¥Ø«Ø§Ø±Ø© ÙƒØ¨ÙŠØ±Ø©ØŒ ÙˆØ§Ù†ØªÙ‡Øª Ø¹Ù„Ù‰ ÙˆÙ‚Ø¹ ${homeGoals}â€“${awayGoals}.`
  ];

  const midVariants = [
    () => scorerLines,
    () => (scorerLines ? scorerLines : "Ù„Ù… ØªÙØ³Ø¬Ù„ ØªÙØ§ØµÙŠÙ„ Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©."),
    () => [scorerLines, redLines].filter(Boolean).join(" ")
  ];

  const tailVariants = [
    () => `ÙˆÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ ÙŠØªÙ…ÙˆØ¶Ø¹ ${normalizeTeamName(homeName)} ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² ${fmtNum(homePos)} Ø¨ÙŠÙ†Ù…Ø§ ÙŠØ­ØªÙ„ ${normalizeTeamName(awayName)} Ø§Ù„Ù…Ø±ØªØ¨Ø© ${fmtNum(awayPos)}.`,
    () => `ØªØ±ØªÙŠØ¨ÙŠÙ‹Ø§: ${normalizeTeamName(homeName)} (${fmtNum(homePos)}) Ùˆ${normalizeTeamName(awayName)} (${fmtNum(awayPos)}).`,
    () => `Ø¹Ù„Ù‰ ØµØ¹ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ ${normalizeTeamName(homeName)} ${homePos} Ù…Ù‚Ø§Ø¨Ù„ ${awayPos} Ù„Ù€${normalizeTeamName(awayName)}.`
  ];

  const parts = [
    leadVariants[templatesIndex % leadVariants.length](),
    midVariants[templatesIndex % midVariants.length](),
    redLines && templatesIndex % 2 === 1 ? "" : redLines, // Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ù†Ø¯Ù…Ø¬ Ø§Ù„Ø·Ø±Ø¯ Ù…Ø¹ Ø§Ù„ÙˆØ³Ø·
    tailVariants[templatesIndex % tailVariants.length]()
  ].filter(Boolean);

  return parts.join("\n");
}

async function generateNews() {
  const matchSelVal = $("matchSelect").value;
  if (!matchSelVal) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¨Ø§Ø±Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  const { fixtureId, leagueId, season } = JSON.parse(matchSelVal);

  try {
    // Fixture main data
    const fxData = await apiGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if (!fx) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø¨Ø§Ø±Ø§Ø©.");

    const leagueName = fx.league?.name || "Ø§Ù„Ø¯ÙˆØ±ÙŠ";
    const roundStr = fx.league?.round || "";
    const homeName = fx.teams?.home?.name || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¶ÙŠÙ";
    const awayName = fx.teams?.away?.name || "Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¶ÙŠÙ";
    const homeId = fx.teams?.home?.id;
    const awayId = fx.teams?.away?.id;
    const homeGoals = fx.goals?.home ?? 0;
    const awayGoals = fx.goals?.away ?? 0;

    // Events (scorers + reds)
    const evData = await apiGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];

    const goals = ev.filter(e => e.type === "Goal").map(e => ({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    const reds = ev.filter(e => e.detail === "Red Card").map(e => ({
      player: e.player?.name || "ØºÙŠØ± Ù…Ø¹Ù„ÙˆÙ…",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    // Standings for positions
    const stData = await apiGet(`/standings?league=${leagueId}&season=${season}`);
    const allStandings = stData.response?.[0]?.league?.standings || [];
    // Many leagues return nested arrays (groups). Flatten:
    const table = [].concat(...allStandings);

    const homeRow = table.find(r => r.team?.id === homeId);
    const awayRow = table.find(r => r.team?.id === awayId);
    const homePos = homeRow?.rank ?? "â€”";
    const awayPos = awayRow?.rank ?? "â€”";

    // Assemble payload
    lastReportData = {
      leagueName,
      roundStr,
      roundLang: $("roundLang").value,
      homeName, awayName,
      homeGoals, awayGoals,
      goalEvents: goals,
      redCards: reds,
      homePos, awayPos
    };

    templatesIndex = 0;
    const text = buildReportText(lastReportData);
    $("newsOutput").value = text;
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
  } catch (e) {
    alert("ØªØ¹Ø°Ù‘Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø¨Ø±: " + e.message);
  }
}

// ---------- UI Listeners ----------
$("refreshBtn").addEventListener("click", loadMatches);
$("generateBtn").addEventListener("click", generateNews);
$("rephraseBtn").addEventListener("click", () => {
  if (!lastReportData) return;
  templatesIndex++;
  $("newsOutput").value = buildReportText(lastReportData);
});
$("copyBtn").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText($("newsOutput").value);
    $("copyBtn").textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®";
    setTimeout(() => $("copyBtn").textContent = "ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ù†Øµ", 1200);
  } catch {
    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
  }
});
$("clearBtn").addEventListener("click", () => {
  $("newsOutput").value = "";
  $("rephraseBtn").disabled = true;
  $("copyBtn").disabled = true;
});

// Load leagues on start (after user pastes key, call again if needed)
loadLeagues();
</script>
</body>
</html>
