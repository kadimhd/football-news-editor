<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محرر أخبار كرة القدم</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border-radius: 1rem; }
    textarea { font-size: 1.05rem; line-height: 1.9; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="p-3 p-md-4">

  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">📰 محرر أخبار نتائج كرة القدم</h3>
      <span class="text-muted small">v1.0</span>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label">اليوم</label>
            <select id="daySelect" class="form-select">
              <option value="today">اليوم</option>
              <option value="yesterday">الأمس</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">الدوري</label>
            <select id="leagueSelect" class="form-select"></select>
            <div class="form-text">يتم تحميل الدوريات الجارية الآن.</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">المباراة</label>
            <select id="matchSelect" class="form-select">
              <option value="">اختر الدوري أولاً</option>
            </select>
          </div>

          <div class="col-12 col-md-2 d-grid">
            <button id="refreshBtn" class="btn btn-outline-secondary">تحديث المباريات</button>
          </div>
        </div>

        <hr/>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">مفتاح API (RapidAPI)</label>
            <input id="apiKey" class="form-control mono" type="password" placeholder="ضع مفتاحك هنا" />
            <div class="form-text">لن يتم حفظ المفتاح، يستخدم محليًا فقط ضمن الصفحة.</div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">لغة الجولة</label>
            <select id="roundLang" class="form-select">
              <option value="arabic" selected>عربي (الجولة 7)</option>
              <option value="raw">كما في الـ API</option>
            </select>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-md-3 d-grid">
            <button id="generateBtn" class="btn btn-primary">✍️ توليد الخبر</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="rephraseBtn" class="btn btn-outline-primary" disabled>🔁 غيّر الصياغة</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="copyBtn" class="btn btn-outline-dark" disabled>📋 نسخ النص</button>
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="clearBtn" class="btn btn-outline-danger">🧹 مسح</button>
          </div>
        </div>

        <div class="mt-4">
          <label class="form-label">النص الإخباري</label>
          <textarea id="newsOutput" rows="12" class="form-control" placeholder="هنا سيظهر الخبر الجاهز للتحرير والنسخ..."></textarea>
        </div>
      </div>
    </div>

    <div class="text-center text-muted small mt-3">
      تم الإنشاء لأغراض تحرير الأخبار بسرعة — ضع مفتاحك من RapidAPI، واختر المباراة، ثم اضغط &laquo;توليد الخبر&raquo;.
    </div>
  </div>

<script>
const API_HOST = "https://api-football-v1.p.rapidapi.com/v3";

// ---------- Helpers ----------
const $ = (id) => document.getElementById(id);
const fmtNum = (n) => new Intl.NumberFormat('ar-EG').format(n);

function toArabicRound(roundStr, fallback="الجولة") {
  // Examples: "Regular Season - 7", "Group A - 3"
  if (!roundStr) return "";
  const m = roundStr.match(/-\s*(\d+)/);
  if (m) return `${fallback} ${m[1]}`;
  return roundStr;
}

function minuteArabic(min) {
  try {
    const m = parseInt(min, 10);
    if (!isNaN(m)) return `الدقيقة ${fmtNum(m)}`;
  } catch {}
  return `الدقيقة ${min}`;
}

function unique(arr) { return Array.from(new Set(arr)); }

function pickRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function normalizeTeamName(name) {
  // Simple normalizer if needed later
  return name;
}

// ---------- API Calls ----------
async function apiGet(path) {
  const key = $("apiKey").value.trim();
  if (!key) throw new Error("يرجى إدخال مفتاح API أولاً.");
  const headers = {
    "x-rapidapi-key": key,
    "x-rapidapi-host": "api-football-v1.p.rapidapi.com"
  };
  const res = await fetch(`${API_HOST}${path}`, { headers });
  if (!res.ok) {
    const text = await res.text();
    throw new Error("خطأ في الجلب: " + res.status + " — " + text);
  }
  const data = await res.json();
  return data;
}

async function loadLeagues() {
  const leaguesSel = $("leagueSelect");
  leaguesSel.innerHTML = `<option>جاري التحميل...</option>`;
  try {
    const data = await apiGet(`/leagues?current=true`);
    // Sort by type & country & name for better UX
    const leagues = data.response.sort((a, b) => {
      const ta = `${a.league.type}-${a.country?.name}-${a.league.name}`;
      const tb = `${b.league.type}-${b.country?.name}-${b.league.name}`;
      return ta.localeCompare(tb, 'ar');
    });
    leaguesSel.innerHTML = "";
    for (const l of leagues) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ id: l.league.id, season: l.seasons?.find(s => s.current)?.year || l.seasons?.[0]?.year });
      opt.textContent = `${l.league.name} (${l.country?.name || "N/A"})`;
      leaguesSel.appendChild(opt);
    }
  } catch (e) {
    leaguesSel.innerHTML = `<option value="">تعذّر تحميل الدوريات (${e.message})</option>`;
  }
}

async function loadMatches() {
  const selVal = $("leagueSelect").value;
  const matchesSel = $("matchSelect");
  matchesSel.innerHTML = `<option>جاري تحميل المباريات...</option>`;
  if (!selVal) return;
  const { id: leagueId, season } = JSON.parse(selVal);

  const dayVal = $("daySelect").value;
  const date = new Date();
  if (dayVal === "yesterday") date.setDate(date.getDate() - 1);
  const ymd = date.toISOString().slice(0,10);

  try {
    const data = await apiGet(`/fixtures?league=${leagueId}&season=${season}&date=${ymd}`);
    const fixtures = data.response || [];
    if (!fixtures.length) {
      matchesSel.innerHTML = `<option value="">لا توجد مباريات لهذا الاختيار</option>`;
      return;
    }
    matchesSel.innerHTML = "";
    for (const f of fixtures) {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ fixtureId: f.fixture.id, leagueId, season });
      opt.textContent = `${f.teams.home.name} ضد ${f.teams.away.name} — ${f.goals.home ?? ""}:${f.goals.away ?? ""}`;
      matchesSel.appendChild(opt);
    }
  } catch (e) {
    matchesSel.innerHTML = `<option value="">تعذّر تحميل المباريات (${e.message})</option>`;
  }
}

// ---------- News Generation ----------
let lastReportData = null;
let templatesIndex = 0;

function buildReportText(payload) {
  const {
    leagueName, roundStr, roundLang, homeName, awayName,
    homeGoals, awayGoals, goalEvents, redCards, homePos, awayPos
  } = payload;

  const arabicRound = (roundLang === "arabic") ? toArabicRound(roundStr) : roundStr;

  const scorerLines = goalEvents.length
    ? "أهداف المباراة جاءت عبر: " + goalEvents.map(g => `${g.player} (${g.team}) في ${minuteArabic(g.minute)}`).join(" / ") + "."
    : "";

  const redLines = redCards.length
    ? "وشهد اللقاء حالات طرد: " + redCards.map(r => `${r.player} (${r.team}) في ${minuteArabic(r.minute)}`).join(" / ") + "."
    : "";

  const outcomeVerb = (() => {
    if (homeGoals > awayGoals) return "انتصر";
    if (homeGoals < awayGoals) return "خسر";
    return "تعادل";
  })();

  const leadVariants = [
    () => `${normalizeTeamName(homeName)} ${outcomeVerb === "انتصر" ? "حصد" : outcomeVerb === "خسر" ? "فشل في نيل" : "اقتسم"} النقاط أمام ${normalizeTeamName(awayName)} ضمن منافسات ${leagueName}${arabicRound ? " في " + arabicRound : ""}، حيث انتهت المواجهة بنتيجة ${homeGoals}–${awayGoals}.`,
    () => `ضمن ${leagueName}${arabicRound ? " (" + arabicRound + ")" : ""}، فرضت نتيجة ${homeGoals}–${awayGoals} كلمتها في مواجهة ${normalizeTeamName(homeName)} مع ${normalizeTeamName(awayName)}.`,
    () => `حملت مواجهة ${normalizeTeamName(homeName)} و${normalizeTeamName(awayName)} في ${leagueName}${arabicRound ? " — " + arabicRound : ""} إثارة كبيرة، وانتهت على وقع ${homeGoals}–${awayGoals}.`
  ];

  const midVariants = [
    () => scorerLines,
    () => (scorerLines ? scorerLines : "لم تُسجل تفاصيل أهداف في السجلات المتاحة."),
    () => [scorerLines, redLines].filter(Boolean).join(" ")
  ];

  const tailVariants = [
    () => `وفي جدول الترتيب، يتموضع ${normalizeTeamName(homeName)} في المركز ${fmtNum(homePos)} بينما يحتل ${normalizeTeamName(awayName)} المرتبة ${fmtNum(awayPos)}.`,
    () => `ترتيبيًا: ${normalizeTeamName(homeName)} (${fmtNum(homePos)}) و${normalizeTeamName(awayName)} (${fmtNum(awayPos)}).`,
    () => `على صعيد الجدول، ${normalizeTeamName(homeName)} ${homePos} مقابل ${awayPos} لـ${normalizeTeamName(awayName)}.`
  ];

  const parts = [
    leadVariants[templatesIndex % leadVariants.length](),
    midVariants[templatesIndex % midVariants.length](),
    redLines && templatesIndex % 2 === 1 ? "" : redLines, // أحيانًا ندمج الطرد مع الوسط
    tailVariants[templatesIndex % tailVariants.length]()
  ].filter(Boolean);

  return parts.join("\n");
}

async function generateNews() {
  const matchSelVal = $("matchSelect").value;
  if (!matchSelVal) {
    alert("يرجى اختيار مباراة أولاً.");
    return;
  }
  const { fixtureId, leagueId, season } = JSON.parse(matchSelVal);

  try {
    // Fixture main data
    const fxData = await apiGet(`/fixtures?id=${fixtureId}`);
    const fx = fxData.response?.[0];
    if (!fx) throw new Error("لا توجد بيانات للمباراة.");

    const leagueName = fx.league?.name || "الدوري";
    const roundStr = fx.league?.round || "";
    const homeName = fx.teams?.home?.name || "الفريق المضيف";
    const awayName = fx.teams?.away?.name || "الفريق الضيف";
    const homeId = fx.teams?.home?.id;
    const awayId = fx.teams?.away?.id;
    const homeGoals = fx.goals?.home ?? 0;
    const awayGoals = fx.goals?.away ?? 0;

    // Events (scorers + reds)
    const evData = await apiGet(`/fixtures/events?fixture=${fixtureId}`);
    const ev = evData.response || [];

    const goals = ev.filter(e => e.type === "Goal").map(e => ({
      player: e.player?.name || "غير معلوم",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    const reds = ev.filter(e => e.detail === "Red Card").map(e => ({
      player: e.player?.name || "غير معلوم",
      team: e.team?.name || "",
      minute: e.time?.elapsed ?? ""
    }));

    // Standings for positions
    const stData = await apiGet(`/standings?league=${leagueId}&season=${season}`);
    const allStandings = stData.response?.[0]?.league?.standings || [];
    // Many leagues return nested arrays (groups). Flatten:
    const table = [].concat(...allStandings);

    const homeRow = table.find(r => r.team?.id === homeId);
    const awayRow = table.find(r => r.team?.id === awayId);
    const homePos = homeRow?.rank ?? "—";
    const awayPos = awayRow?.rank ?? "—";

    // Assemble payload
    lastReportData = {
      leagueName,
      roundStr,
      roundLang: $("roundLang").value,
      homeName, awayName,
      homeGoals, awayGoals,
      goalEvents: goals,
      redCards: reds,
      homePos, awayPos
    };

    templatesIndex = 0;
    const text = buildReportText(lastReportData);
    $("newsOutput").value = text;
    $("rephraseBtn").disabled = false;
    $("copyBtn").disabled = false;
  } catch (e) {
    alert("تعذّر توليد الخبر: " + e.message);
  }
}

// ---------- UI Listeners ----------
$("refreshBtn").addEventListener("click", loadMatches);
$("generateBtn").addEventListener("click", generateNews);
$("rephraseBtn").addEventListener("click", () => {
  if (!lastReportData) return;
  templatesIndex++;
  $("newsOutput").value = buildReportText(lastReportData);
});
$("copyBtn").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText($("newsOutput").value);
    $("copyBtn").textContent = "✅ تم النسخ";
    setTimeout(() => $("copyBtn").textContent = "📋 نسخ النص", 1200);
  } catch {
    alert("لم يتم النسخ تلقائيًا. انسخ يدويًا.");
  }
});
$("clearBtn").addEventListener("click", () => {
  $("newsOutput").value = "";
  $("rephraseBtn").disabled = true;
  $("copyBtn").disabled = true;
});

// Load leagues on start (after user pastes key, call again if needed)
loadLeagues();
</script>
</body>
</html>
